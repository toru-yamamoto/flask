machine:
  timezone:
    Asia/Tokyo
  services:
    - docker
  python:
    version: 2.7.10
  environment:
    FLASK_APP: flaskr.py
    REGISTRY: flaskr
    BLUEMIX_REGISTRY: registry.ng.bluemix.net/dev_yamamoto/flaskr
    ENDPOINT: https://api.ng.bluemix.net

dependencies:
  pre:
    - sudo apt-get install -y jq
    - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
    - sudo dpkg -i cf-cli_amd64.deb
    - cf install-plugin -f https://static-ice.ng.bluemix.net/ibm-containers-linux_x64
    - docker build -t $REGISTRY .:
        pwd: examples/flaskr
  override:
    - pip install flask pytest

test:
  override:
    - py.test:
        pwd: examples/flaskr
    - docker run -d -p 80:80 $REGISTRY; sleep 5
    - curl --retry 10 --retry-delay 5 -v http://localhost
  post:
    - cf api $ENDPOINT
    - cf login -u $BLUEMIX_USER -p $BLUEMIX_PASSWORD -o $BLUEMIX_ORG -s $BLUEMIX_SPACE
    - cf ic login

deployment:
  production:
    branch: bluemix-docker
    commands:
      - examples/flaskr/deploy.sh $REGISTRY $BLUEMIX_REGISTRY-production

  staging:
    branch: bluemix-docker-staging
    commands:
      - examples/flaskr/deploy.sh $REGISTRY $BLUEMIX_REGISTRY-staging
